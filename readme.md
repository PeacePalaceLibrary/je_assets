# Assets for integration of json-editor and WMS identity management in Wordpres ## DescriptionThis repository consists of javascript and php scripts for integration of the forms generator [json-editor](https://github.com/json-editor/json-editor) andOCLC's [identity management API](https://www.oclc.org/developer/develop/web-services/worldshare-identity-management-api.en.html) in Wordpress.The forms generator uses [json schema](https://json-schema.org/) to build forms.The following forms (pages) are defined:* a registration form (new patrons)* an activation page used for email verification after registration* a sign in form (existing patrons)* an account form (existing patrons)The repository must be installed in the directory of the active wordpress theme, e.g. *wp-content/themes/my_theme*. Goto this directory and use the git clone command to download the directory je_assets. You will find the following files and directories.| directories and files  | Description ||---|---|| jsoneditor/      | javascript files used for generating forms || php/             | directory with php scripts || je_functions.php | php file to be required in functions.php of the active theme|| readme.md        | this file |## DependenciesTwig is used. See [https://twig.symfony.com/](https://twig.symfony.com/). If Twig is not installed (e.g. by a plugin)the goto the directory *.../je_assets* and follow the instructions on [https://twig.symfony.com/doc/2.x/installation.html](https://twig.symfony.com/doc/2.x/installation.html).## ConfigurationAll configuration for PHP scripts is in *.../je_assets/php/settings.php*. You might need to change some settings when copying to a production environment.All configuration for Javascript files is in *.../je_assets/jsoneditor/settings.js*. You might need to change some settings when copying to a production environment.## Include *je_functions.php* in *functions.php*Add the following line to the file *functions.php* in your active theme directory:```phprequire_once(get_template_directory().'/je_assets/je_functions.php'); ```If the theme does not have a functions.php file, then add a file called  *functions.php* in the my_theme directory with the line above.*je_functions.php* takes care of three things:* three javascripts are enqueued in wordpress: *je_assets/jsoneditor/jsoneditor.min.js*, *je_assets/jsoneditor/regValidators.js* and   *je_assets/jsoneditor/settings.js*. In the file *regValidators.js* custom validations are defined* an URL parameter *je_ac* is defined. This parameter is used for email verification* a shortcode *[je_form name=….]* is defined. This shortcode is used in wordpress pages.## Wordpress pagesYour Wordpress sites has to have a few extra pages. Create these pages and use the slugs in the table below, because the URL's of these pages are used in the code.| page  | shortcode | slug ||-------|-----------|------|| sign in       | [je\_form name=sign_in]    | sign-in || registration  | [je\_form name=register]   | register || account       | [je\_form name=account]    | account || activation    | [je\_form name=activation] | activation |## RegistrationThe shortcode `[je_form name=register]` inserts the following HTML snippet:``` HTML<div id = "editorDiv">	<div id="editor">	</div>	<button id="submit">Send</button>	<button id="empty">Empty form</button>	<script type="text/javascript" src="http://localhost/wordpress498/wp-content/themes/twentysixteen/je_assets/jsoneditor/lists.js">	</script>	<script type="text/javascript" src="http://localhost/wordpress498/wp-content/themes/twentysixteen/je_assets/jsoneditor/regSchema.js">	</script>	<script type="text/javascript" src="http://localhost/wordpress498/wp-content/themes/twentysixteen/je_assets/jsoneditor/regForm.js">	</script>	<div id="res" class="alert">	</div></div>``` Json-editor generates the form in `div#editor`. The inserted javascripts are:| script | actions ||--------|---------|| lists.js | Contains lists for dropdowns or selections in the form. Used in *regschema.js* || regSchema.js | Contains the schema (definition) of the registration form.  || regForm.js | Contains the initialization of the form and the actions attached to the buttons. |The submit button in the registration form uses a jQuery's AJAX function. It calls *je_assets/php/register.php* and sends the data from the form as an associative array.*je_assets/php/register.php* uses a function `new_customer()`defined in *helpers.php*. This function:* checks whether the username already exists * generates a barcode that does not exist in WMS* generates a sha256 activation code* inserts a blocked and not verified patron record in WMS, with patron type *website*, this results in a ppid of the patron* inserts a record in mysql including username, password, ppid, barcode and activation code* sends a mail to the customer with the activation code## Activation The shortcode `[je_form name=activation]` inserts the following HTML snippet:```html<div id = "editorDiv">  <div id="editor"></div>  <div id="res" class="alert"></div></div>```The script in *je_functions.php* checks whether a parameter *je_ac=[some sha256 code]* exists in the url. If it exists the record is retrieved and:* the patron record in WMS is changed (using the ppid): the user is now unblocked and verified* the record in mysql is changed (activated is set to TRUE) * a mail is send to the customer with their username and barcode## Sign-in and accountThe user has to sign in first, using the page *.../sign-in*. After signing in the page *.../?je_ac=[some sha256 code]* is opened with the data the user has provided before.## Dependencies* OCLC's authorization* OCLC's IDM API* mysqli in PHP* template engine Twig